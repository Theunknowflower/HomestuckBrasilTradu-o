<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // üîë Configura√ß√£o
  const SUPABASE_URL = "https://vhopcdzemdiqtvrwmqqo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZob3BjZHplbWRpcXR2cndtcXFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjc2MTUsImV4cCI6MjA3MzgwMzYxNX0.j8podlPF9lBz2LfzDq1Z0NYF2QA3tQRK-tOIalWz2sI"; // pegue em Settings ‚Üí API ‚Üí anon public
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ======================
  // LOGIN
  // ======================
  async function signInWithGoogle() {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: "google",
    });
    if (error) console.error("Erro no login:", error);
    else console.log("Login iniciado:", data);
  }

  async function getCurrentUser() {
    const { data, error } = await supabase.auth.getUser();
    if (error) return null;
    return data.user;
  }

  // ======================
  // COMENT√ÅRIOS
  // ======================
  async function loadComments() {
    const { data, error } = await supabase
      .from("comments")
      .select("*")
      .order("created_at", { ascending: false });

    const container = document.getElementById("commentSection");

    if (error) {
      container.innerHTML =
        "<div style='color:red'>Erro ao carregar coment√°rios.</div>";
      console.error(error);
      return;
    }

    container.innerHTML = `
      <div id="commentForm" style="margin-bottom:12px">
        <textarea id="newComment" placeholder="Escreva um coment√°rio..." style="width:100%;height:60px"></textarea>
        <button class="btn-small" onclick="addComment()">Enviar</button>
      </div>
      <div id="commentList">
        ${data
          .map(
            (c) => `
          <div class="comment" style="margin-bottom:8px">
            <div style="font-size:13px;color:#666">
              <strong>${c.user ?? "An√¥nimo"}</strong> ‚Äî ${timeAgo(
              c.created_at
            )}
            </div>
            <div>${c.text}</div>
          </div>
        `
          )
          .join("")}
      </div>
    `;
  }

  async function addComment() {
    const textarea = document.getElementById("newComment");
    const text = textarea.value.trim();
    if (!text) return;

    const user = (await getCurrentUser());
    const username = user ? user.email : "Convidado";

    const { error } = await supabase
      .from("comments")
      .insert([{ user: username, text }]);

    if (error) {
      alert("Erro ao enviar coment√°rio: " + error.message);
      return;
    }

    textarea.value = "";
    loadComments();
  }

  function subscribeToComments() {
    supabase
      .channel("comments-channel")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "comments" },
        (payload) => {
          console.log("Novo coment√°rio:", payload.new);
          const list = document.getElementById("commentList");
          if (list) {
            const c = payload.new;
            const div = document.createElement("div");
            div.className = "comment";
            div.style.marginBottom = "8px";
            div.innerHTML = `
              <div style="font-size:13px;color:#666">
                <strong>${c.user ?? "An√¥nimo"}</strong> ‚Äî ${timeAgo(
              c.created_at
            )}
              </div>
              <div>${c.text}</div>
            `;
            list.prepend(div);
          }
        }
      )
      .subscribe();
  }

  // ======================
  // PERFIL + CONQUISTAS
  // ======================
  async function loadProfile() {
    const user = await getCurrentUser();
    const container = document.getElementById("pqContent");

    if (!user) {
      container.innerHTML = "<strong>Sem conta</strong><br><small>Crie um perfil com Gmail</small>";
      return;
    }

    // puxar dados do perfil na tabela "profiles"
    const { data, error } = await supabase
      .from("profiles")
      .select("*")
      .eq("id", user.id)
      .single();

    if (error || !data) {
      container.innerHTML = `<strong>${user.email}</strong><br><small>Perfil n√£o configurado</small>`;
      return;
    }

    container.innerHTML = `
      <strong>${data.username ?? user.email}</strong>
      <br><small>${data.bio ?? "Sem descri√ß√£o"}</small>
    `;

    // carregar conquistas
    const achievementsDiv = document.getElementById("profileAchievements");
    const { data: ach, error: achError } = await supabase
      .from("achievements")
      .select("*")
      .eq("user_id", user.id);

    if (achError) {
      achievementsDiv.innerHTML = "Erro ao carregar conquistas";
      return;
    }

    achievementsDiv.innerHTML = ach.length
      ? ach.map((a) => `<div>üèÜ ${a.title}</div>`).join("")
      : "Nenhuma conquista ainda.";
  }

  // ======================
  // FANARTS
  // ======================
  async function loadFanarts() {
    const user = await getCurrentUser();
    const container = document.getElementById("profileFanarts");
    if (!user) {
      container.innerHTML = "Entre para ver suas fanarts.";
      return;
    }

    const { data, error } = await supabase
      .from("fanarts")
      .select("*")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false });

    if (error) {
      container.innerHTML = "Erro ao carregar fanarts.";
      return;
    }

    container.innerHTML = data.length
      ? data
          .map(
            (f) => `
          <div class="fanart">
            <strong>${f.title}</strong>
            <p>${f.description ?? ""}</p>
            ${f.image_url ? `<img src="${f.image_url}" style="max-width:100%">` : ""}
          </div>
        `
          )
          .join("")
      : "Nenhuma fanart enviada.";
  }

  async function submitPost() {
    const user = await getCurrentUser();
    if (!user) {
      alert("Voc√™ precisa estar logado.");
      return;
    }

    const title = document.getElementById("postTitle").value.trim();
    const description = document.getElementById("postContent").value.trim();
    const image = document.getElementById("postImage").value.trim();

    const { error } = await supabase.from("fanarts").insert([
      {
        user_id: user.id,
        title,
        description,
        image_url: image,
      },
    ]);

    if (error) {
      alert("Erro ao publicar: " + error.message);
      return;
    }

    alert("Fanart publicada!");
    loadFanarts();
    closeModal("newPost");
  }

  // ======================
  // HELPERS
  // ======================
  function timeAgo(dateString) {
    const date = new Date(dateString);
    const seconds = Math.floor((new Date() - date) / 1000);
    const intervals = {
      ano: 31536000,
      m√™s: 2592000,
      dia: 86400,
      hora: 3600,
      minuto: 60,
    };
    for (let key in intervals) {
      const value = intervals[key];
      const interval = Math.floor(seconds / value);
      if (interval >= 1) return `${interval} ${key}${interval > 1 ? "s" : ""} atr√°s`;
    }
    return "agora";
  }

  // ======================
  // INICIALIZA√á√ÉO
  // ======================
  loadComments();
  subscribeToComments();
  loadProfile();
  loadFanarts();
</script>

